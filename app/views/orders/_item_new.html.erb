
<div class="item">
  <h3>
    New item
    <%= link_to "Ã—", "#", class: "remove_item_link" %>
  </h3>

  <div class="field">
    <%= label_tag :product_id %>
    <%= select_tag "order[items_attributes][#{params[:counter]}][product_id]", options_for_select(Product.all.collect { |p| [ p.name, p.id ] }), class: 'product', include_blank: true %>
    <%= text_field_tag "order[items_attributes][#{params[:counter]}][price]", "", readonly: true %>

    <%= label_tag :amount %>
    <%= text_field_tag "order[items_attributes][#{params[:counter]}][amount]" %>
  </div>
</div>

<script type="text/javascript">
  $('.product').change(function(){
    var select_tag = $(this);
    var num = select_tag.val();
    var num_item = select_tag.attr('id').split("_")[3];
    for (product in selected_products) {
      if (selected_products[product] == num_item) delete selected_products[product];
    }
    if (num == 0) {
      $("#" + select_tag.attr('id').replace("_product_id", "_price")).val("");
    } else if (selected_products[num] != null && selected_products[num] != num_item) {
      alert("Product already selected.");
      $("#" + select_tag.attr('id').replace("_product_id", "_price")).val("");
      select_tag.val(0);
    } else {
      selected_products[num] = num_item;
      $.ajax({
        data: {
          product_id: num
        },
        dataType: 'json',
        success: function(json){
          $("#" + select_tag.attr('id').replace("_product_id", "_price")).val(json);
        },
        url: '<%= price_path %>'
      });
    }
    console.log(selected_products);
  });
  $('.remove_item_link').click(function(){
    var select_tag = $(this).parents('.item').find('.product');
    if (num != 0) {
      var num = select_tag.val();
      var num_item = select_tag.attr('id').split("_")[3];
      delete selected_products[num];
    }
    $(this).parents('.item').remove();
    return false;
  });
</script>
